name: Shared Test Steps

on:
  workflow_call:
    inputs:
      python-version:
        description: 'Python version to use'
        required: true
        type: string

jobs:
  run-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          python-version: ${{ inputs.python-version }}

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Process and Update Test Constants
        run: |
          echo "${{ secrets.VALID_SKYFLOW_CREDS_TEST }}" > ./tests/service_account/valid_credentials.json
          STRING_FORMAT=$(echo "${{ secrets.VALID_SKYFLOW_CREDS_TEST }}" | jq -c .)
          DICT_FORMAT=$(echo "${{ secrets.VALID_SKYFLOW_CREDS_TEST }}" | jq .)
          sed -i "s|VALID_CREDENTIALS_STRING = .*|VALID_CREDENTIALS_STRING = '$STRING_FORMAT'|" ./tests/constants/test_constants.py
          sed -i "s|VALID_SERVICE_ACCOUNT_CREDS = .*|VALID_SERVICE_ACCOUNT_CREDS = $DICT_FORMAT|" ./tests/constants/test_constants.py
        shell: bash
      

      - name: 'Run Tests'
        run: |
          pip install -r requirements.txt
          python -m coverage run --source=skyflow --omit=skyflow/generated/*,skyflow/utils/validations/*,skyflow/vault/data/*,skyflow/vault/tokens/*,skyflow/vault/connection/*,skyflow/error/*,skyflow/utils/enums/*,skyflow/vault/controller/_audit.py,skyflow/vault/controller/_bin_look_up.py -m unittest discover

      - name: coverage
        run: coverage xml -o test-coverage.xml

      - name: Codecov
        uses: codecov/codecov-action@v2.1.0
        with:
          token: ${{ secrets.CODECOV_REPO_UPLOAD_TOKEN }}
          files: test-coverage.xml
          name: codecov-skyflow-python
          verbose: true
